name: Update Routes Documentation

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Routes Documentation
        env:
          BASE_URL: "https://nf.kita.blue"
        run: |
          #!/bin/bash
          set -euo pipefail

          # Utility Functions
          sanitize_path() { 
            echo "$1" | tr ' ' '-' | sed -E 's/\.html$//' 
          }

          get_folder_emoji() {
            local path="$1"
            case "$path" in
              *praktikum*) echo "ğŸ”¬" ;;
              *pertemuan*) echo "ğŸ“…" ;;
              *tugas*) echo "ğŸ“‹" ;;
              *docs*) echo "ğŸ“š" ;;
              *src*) echo "ğŸ’»" ;;
              *test*) echo "ğŸ§ª" ;;
              *) echo "ğŸ“" ;;
            esac
          }

          format_display_name() { 
            echo "$1" | 
              sed 's/-/ /g' | 
              awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1'
          }

          # Prepare README
          [[ -f README.md ]] || echo "# Project Documentation" > README.md

          # Find HTML files
          mapfile -t html_files < <(find . -type f -name "*.html" ! -path "./README.md" ! -path '*/\.*' | sort)
          [[ ${#html_files[@]} -eq 0 ]] && exit 0

          {
            # Preserve existing content before routes section
            sed '/## ğŸ“„ Available Routes/,$d' README.md

            # Routes section header
            echo -e "\n## ğŸ“„ Available Routes\n"
            echo -e "*Last updated: $(date "+%Y-%m-%d %H:%M UTC")*\n"

            echo -e "<details open>\n<summary>ğŸ—‚ï¸ Project Structure</summary>\n"

            # Recursive directory processing function
            process_directory() {
              local base_path="$1"
              local indent="${2:-}"
              local depth="${3:-0}"

              # Find files in current directory
              local index_file=$(find "$base_path" -maxdepth 1 -type f -name "index.html")
              local other_files=$(find "$base_path" -maxdepth 1 -type f -name "*.html" ! -name "index.html")
              local subdirs=$(find "$base_path" -maxdepth 1 -type d ! -path '*/\.*' | tail -n +2)

              # Process only if files or subdirectories exist
              if [[ -n "$index_file$other_files$subdirs" ]]; then
                local folder_emoji=$(get_folder_emoji "$base_path")
                local relative_path="${base_path#./}"

                # Print directory header with appropriate indentation
                if [[ "$depth" -eq 0 ]]; then
                  echo "${indent}### ${folder_emoji} ${relative_path}"
                elif [[ "$depth" -eq 1 ]]; then
                  echo "${indent}#### ${folder_emoji} ${relative_path}"
                else
                  echo "${indent}##### ${folder_emoji} ${relative_path}"
                fi
                echo ""

                # Index page link
                if [[ -n "$index_file" ]]; then
                  echo "${indent}- [ğŸ  Overview]($BASE_URL/${relative_path})"
                fi

                # Other files in directory
                if [[ -n "$other_files" ]]; then
                  while IFS= read -r file; do
                    local clean_path=$(sanitize_path "${file#./}")
                    local basename=$(basename "$clean_path" .html)
                    local display_name=$(format_display_name "$basename")
                    echo "${indent}- [ğŸ“„ $display_name]($BASE_URL/$clean_path)"
                  done <<< "$other_files"
                fi

                # Recursively process subdirectories
                if [[ -n "$subdirs" ]]; then
                  while IFS= read -r subdir; do
                    process_directory "$subdir" "$indent  " $((depth + 1))
                  done <<< "$subdirs"
                fi
              fi
            }

            # Start processing from root
            process_directory "."

            echo -e "\n</details>\n---\n"
            
            # Project statistics
            total_dirs=$(find . -type d ! -path '*/\.*' | wc -l)
            echo "ğŸ“Š **Project Stats**:"
            echo "- ğŸ“„ Pages: ${#html_files[@]}"
            echo "- ğŸ“‚ Folders: $((total_dirs - 1))"
            echo -e "\nğŸ’¡ *Automatically updated on page changes.*"
          } > README.new

          # Update README only if changes exist
          if ! cmp -s README.md README.new; then
            mv README.new README.md
            echo "should_commit=true" >> "$GITHUB_ENV"
          else
            rm README.new
            echo "should_commit=false" >> "$GITHUB_ENV"
          fi

      - name: Commit Changes
        if: env.should_commit == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "ğŸ“ Update routes documentation [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}