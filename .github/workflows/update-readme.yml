name: Update Routes Documentation

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Routes Documentation
        env:
          BASE_URL: "https://nf.kita.blue"
        run: |
          #!/bin/bash
          set -euo pipefail

          # Simplified utility functions
          sanitize_path() { echo "$1" | tr ' ' '-' | sed -E 's/\.html$//' ; }
          get_folder_emoji() {
            case "$1" in
              *blog*) echo "ğŸ“" ;;
              *docs*) echo "ğŸ“š" ;;
              *pages*) echo "ğŸ“ƒ" ;;
              *api*) echo "ğŸ› ï¸" ;;
              *) echo "ğŸ“" ;;
            esac
          }
          format_display_name() { 
            echo "$1" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1'
          }

          # Create README if not exists
          [[ -f README.md ]] || echo "# Project Documentation" > README.md

          # Find HTML files and non-hidden directories
          mapfile -t html_files < <(find . -type f -name "*.html" ! -path "./README.md" | sort)
          mapfile -t dirs < <(find . -type d ! -path '*/\.*' | sed 's|^\./||' | sort)

          # Exit if no files or directories
          [[ ${#html_files[@]} -eq 0 && ${#dirs[@]} -eq 0 ]] && exit 0

          # Generate routes documentation
          {
            # Preserve content before routes section
            sed '/## ğŸ“„ Available Routes/,$d' README.md

            # Routes section header
            echo -e "\n## ğŸ“„ Available Routes\n"
            echo -e "*Last updated: $(date "+%Y-%m-%d %H:%M UTC")*\n"

            echo -e "<details>\n<summary>Click to expand routes and folders</summary>\n"

            # Group HTML files by directory
            declare -A folder_files
            declare -A index_files

            for file in "${html_files[@]}"; do
              clean_path=$(sanitize_path "${file#./}")
              folder=$(dirname "$clean_path")
              basename=$(basename "$clean_path")
              
              [[ "$basename" == "index" ]] && index_files["$folder"]="$file"
              [[ "$folder" == "." ]] && folder=""
              folder_files["$folder"]+="$file "
            done

            # Process directories
            for dir in "${dirs[@]}"; do
              [[ "$dir" == "." ]] && continue

              # Skip empty directories
              [[ -z "${folder_files[$dir]}" && -z "${index_files[$dir]}" ]] && continue

              folder_emoji=$(get_folder_emoji "$dir")
              index_route=${index_files[$dir]:+/$dir}

              echo -e "\n### ${folder_emoji} ${dir}\n"
              [[ -n "$index_route" ]] && echo "- [ğŸ  ${dir} Overview]($BASE_URL$index_route)"

              for file in ${folder_files[$dir]}; do
                clean_path=$(sanitize_path "${file#./}")
                basename=$(basename "$clean_path")
                [[ "$basename" == "index" ]] && continue

                display_name=$(format_display_name "$basename")
                echo "- [ğŸ“„ $display_name]($BASE_URL/$clean_path)"
              done
            done

            # Handle root directory
            root_files="${folder_files[.]:-}"
            if [[ -n "${index_files[.]:-}" || -n "$root_files" ]]; then
              echo -e "\n### ğŸ  Root\n"
              [[ -n "${index_files[.]:-}" ]] && echo "- [ğŸ  Homepage]($BASE_URL/)"

              for file in $root_files; do
                clean_path=$(sanitize_path "${file#./}")
                basename=$(basename "$clean_path")
                [[ "$basename" == "index" ]] && continue

                display_name=$(format_display_name "$basename")
                echo "- [ğŸ“„ $display_name]($BASE_URL/$clean_path)"
              done
            fi

            echo -e "\n</details>\n---\n"
            echo "ğŸ“Š **Stats**: ${#html_files[@]} page(s) in $((${#dirs[@]} - 1)) folder(s)"
            echo -e "\nğŸ’¡ *Routes auto-updated on page changes.*"
          } > README.new

          # Update README only if changes exist
          if ! cmp -s README.md README.new; then
            mv README.new README.md
            echo "should_commit=true" >> "$GITHUB_ENV"
          else
            rm README.new
            echo "should_commit=false" >> "$GITHUB_ENV"
          fi

      - name: Commit Changes
        if: env.should_commit == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "ğŸ“ Update routes documentation [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}