name: Update README with File-based Routing

on:
  push:
    branches:
      - main  # Adjust to your preferred branch
  workflow_dispatch:

permissions:
  contents: write  # Allows the action to push changes

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Generate File Routes
        id: generate_routes
        env:
          BASE_URL: "https://sttnf.github.io/pmweb"
        run: |
          # Initialize the routes markdown section
          echo "## File Routes" > file-routes.md
          echo "" >> file-routes.md

          # Find all HTML files, excluding README.md, and sort them
          files=$(find . -type f -name "*.html" ! -path "./README.md" | sort)

          # Read existing routes from README.md for comparison
          if grep -q "## File Routes" README.md; then
            awk '/## File Routes/{flag=1; next} /##/{flag=0} flag' README.md > current-routes.md
          else
            touch current-routes.md
          fi

          # Initialize a variable to keep track of the current folder
          current_folder=""
          changes_found=false

          # Loop through each file to group by folder
          while read -r path; do
            # Remove "./" prefix and ".html" extension
            relative_path=$(echo "$path" | sed 's|^\./||; s|\.html$||')

            # Extract the folder name (if any) and the file name
            folder=$(dirname "$relative_path")
            file=$(basename "$relative_path")

            # Determine if this is an index file
            if [[ "$file" == "index" ]]; then
              route_text="/"
            else
              route_text=$file
            fi

            # Check if the folder header exists in current README and add new entries only
            folder_header="### $folder"
            if grep -q "$folder_header" current-routes.md; then
              # Only add files not already listed under the existing folder
              if ! grep -q "\- \[$route_text\]" current-routes.md; then
                echo "- [$route_text]($BASE_URL/$relative_path)" >> file-routes.md
                changes_found=true
              fi
            else
              # New folder - add header and file
              echo -e "\n### $folder" >> file-routes.md
              echo "- [$route_text]($BASE_URL/$relative_path)" >> file-routes.md
              changes_found=true
            fi
          done <<< "$files"

          # If changes are found, prepare to update README.md
          if [ "$changes_found" = true ]; then
            awk -v new_routes="$(cat file-routes.md)" '/## File Routes/{print; print new_routes; next}1' README.md > README.tmp
            mv README.tmp README.md
            echo "README updated."
            echo "should_commit=true" >> $GITHUB_ENV
          else
            echo "No changes detected."
          fi

          # Clean up temporary files
          rm -f current-routes.md file-routes.md

      - name: Commit and Push changes
        if: env.should_commit == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md  # Only add README.md
          git commit -m "Update README with file-based routes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
