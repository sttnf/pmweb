name: Update README with File-based Routing

on:
  push:
    branches:
      - main  # Adjust to your preferred branch
  workflow_dispatch:

permissions:
  contents: write  # Allows the action to push changes

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Generate File Routes
        id: generate_routes
        env:
          BASE_URL: "https://sttnf.github.io/pmweb"
        run: |
          # Initialize the routes markdown section
          echo "## File Routes" > file-routes.md
          echo "" >> file-routes.md

          # Find all HTML files, excluding README.md, and sort them
          files=$(find . -type f -name "*.html" ! -path "./README.md" | sort)

          # Initialize a variable to keep track of the current folder
          current_folder=""

          # Loop through each file to group by folder
          while read -r path; do
            # Remove "./" prefix and ".html" extension
            relative_path=$(echo "$path" | sed 's|^\./||; s|\.html$||')

            # Extract the folder name (if any) and the file name
            folder=$(dirname "$relative_path")
            file=$(basename "$relative_path")

            # Format the route text ("/" for index files)
            route_text=$file
            if [[ "$file" == "index" ]]; then
              route_text="/"
            fi

            # Add a new folder header if we've moved to a different folder
            if [[ "$folder" != "." && "$folder" != "$current_folder" ]]; then
              echo -e "\n### $folder" >> file-routes.md
              current_folder="$folder"
            fi

            # Create the GitHub Pages-compatible URL
            url="$BASE_URL/$relative_path"
            
            # Append the route with URL to the routes file
            echo "- [$route_text]($url)" >> file-routes.md
          done <<< "$files"

      - name: Check and Update README
        run: |
          if grep -q "## File Routes" README.md; then
            # Extract the current routes section
            awk '/## File Routes/{flag=1; next} /##/{flag=0} flag' README.md > current-routes.md || true

            # Check if there's a difference
            if ! cmp -s file-routes.md current-routes.md; then
              awk -v new_routes="$(cat file-routes.md)" '/## File Routes/{print; print new_routes; next}1' README.md > README.tmp
              mv README.tmp README.md
              echo "README updated."
              echo "should_commit=true" >> $GITHUB_ENV
            fi
          else
            # If no routes section exists, append it
            cat file-routes.md >> README.md
            echo "README updated with new routes section."
            echo "should_commit=true" >> $GITHUB_ENV
          fi

      - name: Commit and Push changes
        if: env.should_commit == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with file-based routes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
