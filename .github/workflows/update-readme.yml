name: Update README with File-based Routing

on:
  push:
    branches:
      - main  # Adjust to your preferred branch
  workflow_dispatch:

permissions:
  contents: write  # Allows the action to push changes

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Generate File Routes
        id: generate_routes
        env:
          BASE_URL: "https://sttnf.github.io/pmweb"
        run: |
          # Initialize routes markdown section
          echo "## File Routes" > file-routes.md
          echo "" >> file-routes.md

          # List all .html files, excluding README.md, and generate links
          find . -type f -name "*.html" ! -path "./README.md" | while read path; do
            # Format the path and URL
            route=$(echo "$path" | sed 's|^\./||; s|\.html$||')
            url="$BASE_URL/$route"
            echo "- [$route]($url)" >> file-routes.md
          done

      - name: Check and Update README
        run: |
          if grep -q "## File Routes" README.md; then
            # Extract the current routes section
            awk '/## File Routes/{flag=1; next} /##/{flag=0} flag' README.md > current-routes.md || true

            # Check if there's a difference
            if ! cmp -s file-routes.md current-routes.md; then
              awk -v new_routes="$(cat file-routes.md)" '/## File Routes/{print; print new_routes; next}1' README.md > README.tmp
              mv README.tmp README.md
              echo "README updated."
              echo "should_commit=true" >> $GITHUB_ENV
            fi
          else
            # If no routes section exists, append it
            cat file-routes.md >> README.md
            echo "README updated with new routes section."
            echo "should_commit=true" >> $GITHUB_ENV
          fi

      - name: Commit and Push changes
        if: env.should_commit == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with file-based routes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
